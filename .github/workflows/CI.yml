name: CI

on:
  push:
    branches:
      - main
      - master
    tags:
      - "*"
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  rust-quality:
    name: Rust Quality
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
      - name: Check formatting
        run: cargo fmt --all -- --check
      - name: Lint with clippy
        run: cargo clippy --all --benches --tests --examples --all-features -- -D clippy::pedantic -D clippy::nursery

  cargo-deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
      - uses: taiki-e/install-action@f176c07a0a40cbfdd08ee9aa8bf1655701d11e69
        with:
          tool: cargo-deny
      - name: Check Rust dependency policy
        run: cargo deny check all

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check dependency changes
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261
        with:
          fail-on-severity: moderate

  linux:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        include:
          - target: x86_64
            manylinux: "2_28"
          - target: x86
            manylinux: "manylinux2014"
          - target: aarch64
            manylinux: "2_28"
          - target: armv7
            manylinux: "2_28"
          - target: ppc64le
            manylinux: "2_28"
          - target: s390x
            manylinux: "2_28"
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: 3.x
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          args: --release --out dist --find-interpreter
          sccache: "true"
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist


  musllinux:
    runs-on: ${{ matrix.platform.runner }}
    timeout-minutes: 45
    strategy:
      matrix:
        platform:
          - runner: ubuntu-latest
            target: x86_64
          - runner: ubuntu-latest
            target: x86
          - runner: ubuntu-latest
            target: aarch64
          - runner: ubuntu-latest
            target: armv7
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: 3.x
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: "true"
          manylinux: musllinux_1_2
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-musllinux-${{ matrix.platform.target }}
          path: dist

  windows:
    runs-on: ${{ matrix.platform.runner }}
    timeout-minutes: 45
    strategy:
      matrix:
        platform:
          - runner: windows-latest
            target: x64
          - runner: windows-latest
            target: x86
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: 3.x
          architecture: ${{ matrix.platform.target }}
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: "true"
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-windows-${{ matrix.platform.target }}
          path: dist

  macos:
    runs-on: ${{ matrix.platform.runner }}
    timeout-minutes: 45
    strategy:
      matrix:
        platform:
          - runner: macos-14
            target: x86_64
          - runner: macos-14
            target: aarch64
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: 3.x
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: "true"
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-macos-${{ matrix.platform.target }}
          path: dist

  sdist:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Build sdist
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-sdist
          path: dist

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      HF_HOME: ${{ github.workspace }}/.hf-cache
      BENCH_DATASET_KEY: ag_news
      BENCH_MAX_ROWS: "10000"
      BENCH_FULL_SMOKE_MAX_ROWS: "2000"
      BENCH_NUM_PERM: "128"
      BENCH_NUM_BANDS: "8"
      BENCH_THRESHOLD: "0.8"
      BENCH_PR_WARMUP_RUNS: "1"
      BENCH_PR_MEASURED_RUNS: "3"
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.9"
      - uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e
        with:
          enable-cache: true

      - name: Create benchmark directories
        shell: bash
        run: |
          mkdir -p .bench

      - name: Prepare PR base checkout
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          echo "Base SHA: ${BASE_SHA}"
          git fetch --no-tags origin "${BASE_SHA}"
          git worktree add ../rensa-base "${BASE_SHA}"
          echo "BASE_DIR=$(cd ../rensa-base && pwd)" >> "$GITHUB_ENV"

      - name: Run PR base and head benchmarks
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail

          uv venv --python 3.9 "${GITHUB_WORKSPACE}/.venv"
          uv sync --python "${GITHUB_WORKSPACE}/.venv/bin/python" --group dev --no-install-project
          uv pip install \
            --python "${GITHUB_WORKSPACE}/.venv/bin/python" \
            "datasets>=2.20" \
            "datasketch>=1.9" \
            "FastSketchLSH" \
            "tqdm>=4.66"
          BENCH_VENV="${GITHUB_WORKSPACE}/.venv"
          BENCH_PY="${GITHUB_WORKSPACE}/.venv/bin/python"
          BENCH_MATURIN="${GITHUB_WORKSPACE}/.venv/bin/maturin"

          run_commit_benchmark() {
            local commit_dir="$1"
            local output_json="$2"
            local output_log="$3"
            local label="$4"

            pushd "${commit_dir}" >/dev/null
            VIRTUAL_ENV="${BENCH_VENV}" PATH="${BENCH_VENV}/bin:${PATH}" "${BENCH_MATURIN}" develop --release
            popd >/dev/null

            "${BENCH_PY}" "${GITHUB_WORKSPACE}/benchmarks/simple_benchmark.py" \
              --dataset "${BENCH_DATASET_KEY}" \
              --max-rows "${BENCH_MAX_ROWS}" \
              --num-perm "${BENCH_NUM_PERM}" \
              --num-bands "${BENCH_NUM_BANDS}" \
              --threshold "${BENCH_THRESHOLD}" \
              --warmup-runs "${BENCH_PR_WARMUP_RUNS}" \
              --measured-runs "${BENCH_PR_MEASURED_RUNS}" \
              --output-json "${output_json}" \
              | tee "${output_log}"

            echo "Completed ${label} benchmark."
          }

          run_commit_benchmark \
            "${GITHUB_WORKSPACE}" \
            "${GITHUB_WORKSPACE}/.bench/head.json" \
            "${GITHUB_WORKSPACE}/.bench/head_summary.txt" \
            "head"

          run_commit_benchmark \
            "${BASE_DIR}" \
            "${GITHUB_WORKSPACE}/.bench/base.json" \
            "${GITHUB_WORKSPACE}/.bench/base_summary.txt" \
            "base"

      - name: Validate PR benchmark outputs
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          "${GITHUB_WORKSPACE}/.venv/bin/python" - <<'PY' | tee .bench/validation_pr.txt
          import json

          with open(".bench/head.json", "r", encoding="utf-8") as handle:
              head = json.load(handle)
          with open(".bench/base.json", "r", encoding="utf-8") as handle:
              base = json.load(handle)

          required_engines = ("datasketch", "fastsketch", "rensa_r", "rensa_c")
          for engine in required_engines:
              if engine not in head["summary"]["engine_medians"]:
                  raise SystemExit(f"missing head engine metrics: {engine}")
              if engine not in base["summary"]["engine_medians"]:
                  raise SystemExit(f"missing base engine metrics: {engine}")

          head_total = float(head["summary"]["engine_medians"]["rensa_r"]["median_total"])
          base_total = float(base["summary"]["engine_medians"]["rensa_r"]["median_total"])
          if base_total <= 0:
              raise SystemExit("invalid base rensa_r median_total")
          slowdown_fraction = (head_total / base_total) - 1.0

          if slowdown_fraction > 0.10:
              raise SystemExit(
                  f"rensa_r slowdown too high: head={head_total:.6f}s base={base_total:.6f}s "
                  f"slowdown={slowdown_fraction:.2%}"
              )

          print(
              f"PASS: rensa_r median_total head={head_total:.6f}s "
              f"base={base_total:.6f}s slowdown={slowdown_fraction:.2%}"
          )
          PY

      - name: Run full benchmark smoke
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          "${GITHUB_WORKSPACE}/.venv/bin/python" benchmarks/full_benchmark.py \
            --datasets "${BENCH_DATASET_KEY}" \
            --threads "1,8" \
            --max-rows "${BENCH_FULL_SMOKE_MAX_ROWS}" \
            --num-perm "${BENCH_NUM_PERM}" \
            --num-bands "${BENCH_NUM_BANDS}" \
            --threshold "${BENCH_THRESHOLD}" \
            --warmup-runs 0 \
            --repetitions 1 \
            --output-json .bench/full_head_smoke.json \
            | tee .bench/full_head_smoke_summary.txt

      - name: Run push smoke benchmark
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          uv venv --python 3.9 .venv
          uv sync --python .venv/bin/python --group dev --no-install-project
          uv pip install \
            --python .venv/bin/python \
            "datasets>=2.20" \
            "datasketch>=1.9" \
            "FastSketchLSH" \
            "tqdm>=4.66"

          VIRTUAL_ENV="${GITHUB_WORKSPACE}/.venv" PATH="${GITHUB_WORKSPACE}/.venv/bin:${PATH}" .venv/bin/maturin develop --release

          .venv/bin/python benchmarks/simple_benchmark.py \
            --dataset "${BENCH_DATASET_KEY}" \
            --max-rows "${BENCH_MAX_ROWS}" \
            --num-perm "${BENCH_NUM_PERM}" \
            --num-bands "${BENCH_NUM_BANDS}" \
            --threshold "${BENCH_THRESHOLD}" \
            --warmup-runs 0 \
            --measured-runs 1 \
            --output-json .bench/head_smoke.json \
            | tee .bench/head_smoke_summary.txt

          .venv/bin/python benchmarks/full_benchmark.py \
            --datasets "${BENCH_DATASET_KEY}" \
            --threads "1,8" \
            --max-rows "${BENCH_FULL_SMOKE_MAX_ROWS}" \
            --num-perm "${BENCH_NUM_PERM}" \
            --num-bands "${BENCH_NUM_BANDS}" \
            --threshold "${BENCH_THRESHOLD}" \
            --warmup-runs 0 \
            --repetitions 1 \
            --output-json .bench/full_head_smoke.json \
            | tee .bench/full_head_smoke_summary.txt

      - name: Validate push smoke benchmark outputs
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          .venv/bin/python - <<'PY' | tee .bench/validation_smoke.txt
          import json

          with open(".bench/head_smoke.json", "r", encoding="utf-8") as handle:
              simple_payload = json.load(handle)
          with open(".bench/full_head_smoke.json", "r", encoding="utf-8") as handle:
              full_payload = json.load(handle)

          required_simple = ("datasketch", "fastsketch", "rensa_r", "rensa_c")
          for engine in required_simple:
              if engine not in simple_payload["summary"]["engine_medians"]:
                  raise SystemExit(f"missing simple benchmark engine metrics: {engine}")

          if not full_payload.get("results"):
              raise SystemExit("full benchmark smoke produced no results")

          required_full = ("datasketch", "fastsketch", "rensa")
          lane = full_payload["results"][0]["summary"]["engine_medians"]
          for engine in required_full:
              if engine not in lane:
                  raise SystemExit(f"missing full benchmark engine metrics: {engine}")

          print("PASS: simple + full smoke benchmark outputs are valid")
          PY

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: performance-check-artifacts
          path: |
            .bench/*.json
            .bench/*.txt

      - name: Cleanup PR base checkout
        if: always() && github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          if [ -d ../rensa-base ]; then
            git worktree remove --force ../rensa-base
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.9"
      - uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e
        with:
          enable-cache: true
      
      - name: Install dependencies
        run: |
          uv venv --python 3.9 .venv
          uv sync --python .venv/bin/python --group dev --no-install-project
          
      - name: Build & Install Rensa
        run: |
          uv run --python .venv/bin/python maturin develop --release
        
      - name: Run tests
        run: |
          uv run --python .venv/bin/python pytest tests/

  release:
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: "startsWith(github.ref, 'refs/tags/')"
    needs: [rust-quality, cargo-deny, linux, musllinux, windows, macos, sdist, performance-check, test]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e
        with:
          packages-dir: dist
