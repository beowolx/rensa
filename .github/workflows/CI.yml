name: CI

on:
  push:
    branches:
      - main
      - master
    tags:
      - "*"
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  rust-quality:
    name: Rust Quality
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
      - name: Check formatting
        run: cargo fmt --all -- --check
      - name: Lint with clippy
        run: cargo clippy --all --benches --tests --examples --all-features -- -D clippy::pedantic -D clippy::nursery

  cargo-deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
      - uses: taiki-e/install-action@f176c07a0a40cbfdd08ee9aa8bf1655701d11e69
        with:
          tool: cargo-deny
      - name: Check Rust advisories
        run: cargo deny check advisories

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check dependency changes
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261
        with:
          fail-on-severity: moderate

  linux:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        include:
          - target: x86_64
            manylinux: "2_28"
          - target: x86
            manylinux: "manylinux2014"
          - target: aarch64
            manylinux: "2_28"
          - target: armv7
            manylinux: "2_28"
          - target: ppc64le
            manylinux: "2_28"
          - target: s390x
            manylinux: "2_28"
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: 3.x
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          args: --release --out dist --find-interpreter
          sccache: "true"
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist


  musllinux:
    runs-on: ${{ matrix.platform.runner }}
    timeout-minutes: 45
    strategy:
      matrix:
        platform:
          - runner: ubuntu-latest
            target: x86_64
          - runner: ubuntu-latest
            target: x86
          - runner: ubuntu-latest
            target: aarch64
          - runner: ubuntu-latest
            target: armv7
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: 3.x
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: "true"
          manylinux: musllinux_1_2
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-musllinux-${{ matrix.platform.target }}
          path: dist

  windows:
    runs-on: ${{ matrix.platform.runner }}
    timeout-minutes: 45
    strategy:
      matrix:
        platform:
          - runner: windows-latest
            target: x64
          - runner: windows-latest
            target: x86
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: 3.x
          architecture: ${{ matrix.platform.target }}
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: "true"
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-windows-${{ matrix.platform.target }}
          path: dist

  macos:
    runs-on: ${{ matrix.platform.runner }}
    timeout-minutes: 45
    strategy:
      matrix:
        platform:
          - runner: macos-14
            target: x86_64
          - runner: macos-14
            target: aarch64
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: 3.x
      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: "true"
      - name: Upload wheels
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-macos-${{ matrix.platform.target }}
          path: dist

  sdist:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Build sdist
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: wheels-sdist
          path: dist

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.9"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Prepare Python Environment
        shell: bash
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install maturin
          pip install -r requirements.txt

      - name: Build & Install Rensa Locally
        shell: bash
        run: |
          source .venv/bin/activate
          maturin develop --release

      - name: Run Benchmark
        shell: bash
        run: |
          source .venv/bin/activate
          python benchmarks/simple_benchmark.py > benchmark_log.txt
          cat benchmark_log.txt

      - name: Enforce Performance and Jaccard Similarity
        shell: bash
        run: |
          set -e
          set -o pipefail

          # Helper function to check performance
          check_performance() {
            local method_name="$1"
            local reference_name="$2"
            local min_speedup="$3"
            local speedup

            echo "Checking performance: ${method_name} vs ${reference_name} (min speedup: ${min_speedup}x)"

            # Parse from the detailed performance table
            local table_line
            table_line=$(grep "^${method_name}[ ]*[0-9]*\.[0-9]*[ ]*[0-9]*\.[0-9]*[ ]*x" benchmark_log.txt | head -1 || true)
            
            if [ -z "$table_line" ]; then
              echo "FAILURE: Could not find performance table line for ${method_name}."
              exit 1
            fi
            
            echo "Detected table line: $table_line"
            # Extract speedup vs Datasketch from the table (third column)
            speedup=$(echo "$table_line" | awk '{print $3}' | sed 's/x$//')
            
            if [ -z "$speedup" ]; then
              echo "FAILURE: Could not parse speedup for ${method_name} from table line: $table_line"
              exit 1
            fi
            echo "${method_name} speedup over ${reference_name} = $speedup"

            if (( $(echo "$speedup < $min_speedup" | bc -l) )); then
              echo "FAILURE: ${method_name} is only ${speedup}x faster than ${reference_name} (Requirement: >= ${min_speedup}x)."
              exit 1
            else
              echo "SUCCESS: ${method_name} is ${speedup}x faster than ${reference_name} (Requirement: >= ${min_speedup}x)."
            fi
          }

          # Helper function to check Jaccard similarity
          check_jaccard() {
            local method1_name="$1"
            local method2_name="$2"
            local min_expected_jaccard="$3"
            local jaccard_line
            local jaccard

            echo "Checking Jaccard similarity: ${method1_name} vs ${method2_name} (min expected: ${min_expected_jaccard})"

            jaccard_line=$(grep "Jaccard similarity between ${method1_name} and ${method2_name}:" benchmark_log.txt || true)
            
            if [ -z "$jaccard_line" ]; then
                # Try reversed order if the benchmark might print it that way
                jaccard_line=$(grep "Jaccard similarity between ${method2_name} and ${method1_name}:" benchmark_log.txt || true)
            fi

            if [ -z "$jaccard_line" ]; then
                echo "FAILURE: Could not find Jaccard similarity line for ${method1_name} vs ${method2_name}."
                exit 1
            fi

            echo "Detected Jaccard line: $jaccard_line"
            jaccard=$(echo "$jaccard_line" | awk '{print $NF}')
            
            if [ -z "$jaccard" ]; then
                echo "FAILURE: Could not parse Jaccard similarity for ${method1_name} vs ${method2_name} from line: $jaccard_line"
                exit 1
            fi
            echo "Parsed Jaccard for ${method1_name} vs ${method2_name} = $jaccard"

            if (( $(echo "$jaccard < $min_expected_jaccard" | bc -l) )); then
              echo "FAILURE: Jaccard similarity for ${method1_name} vs ${method2_name} is ${jaccard}, expected >= ${min_expected_jaccard}."
              exit 1
            else
              echo "SUCCESS: Jaccard similarity for ${method1_name} vs ${method2_name} is ${jaccard} (>= ${min_expected_jaccard})."
            fi
          }
          
          source .venv/bin/activate
          
          echo "--- Validating benchmark_log.txt content ---"
          if [ ! -f benchmark_log.txt ]; then
            echo "benchmark_log.txt not found!"
            exit 1
          fi
          echo "benchmark_log.txt first 10 and last 20 lines:"
          head -n 10 benchmark_log.txt
          echo "..."
          tail -n 30 benchmark_log.txt # Increased tail for more context on Jaccard/Perf sections
          echo "--- End of benchmark_log.txt preview ---"

          # Performance checks (against Datasketch, >= 10.0x for R-MinHash and C-MinHash)
          check_performance "R-MinHash" "Datasketch" 10.0
          check_performance "C-MinHash" "Datasketch" 10.0
          
          # Jaccard similarity checks
          echo "--- Checking Jaccard Similarities vs Datasketch ---"
          check_jaccard "Datasketch" "R-MinHash" 1.0
          check_jaccard "Datasketch" "C-MinHash" 0.9
          
          echo "--- Checking Jaccard Similarities Among Implemented Methods ---"
          # Assuming R-MinHash vs C-MinHash should also be >= 0.9, adjust if necessary
          check_jaccard "R-MinHash" "C-MinHash" 0.9

          echo "All performance and Jaccard similarity checks passed successfully!"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.9"
          cache: pip
          cache-dependency-path: requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
          
      - name: Build & Install Rensa
        run: |
          source .venv/bin/activate
          maturin develop --release
        
      - name: Run tests
        run: |
          source .venv/bin/activate
          pytest tests/

  release:
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: "startsWith(github.ref, 'refs/tags/')"
    needs: [rust-quality, cargo-deny, linux, musllinux, windows, macos, sdist, performance-check, test]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e
        with:
          packages-dir: dist
